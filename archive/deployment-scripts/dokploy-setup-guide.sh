#!/bin/bash

# EarthCare Network - Dokploy Configuration Guide
echo "ğŸ¯ EarthCare Network Dokploy Configuration Guide"
echo "=================================================="
echo ""
echo "âœ… Current Status:"
echo "   - Dokploy Dashboard: http://157.230.173.94:3000"
echo "   - Directory Service: âœ… Running on port 8080"
echo "   - Database (PostgreSQL): âœ… Running on port 5432"
echo "   - Cache (Redis): âœ… Running on port 6379"
echo "   - MCP Server: Starting on port 8090"
echo ""
echo "ğŸ”§ Dokploy Login Credentials:"
echo "   Email: arye@earthcare.network"
echo "   Password: KeepGoin!!!"
echo ""
echo "ğŸ“‹ Step-by-step Dokploy Configuration:"
echo ""
echo "1ï¸âƒ£  Open Dokploy Dashboard: http://157.230.173.94:3000"
echo "2ï¸âƒ£  Login with the credentials above"
echo "3ï¸âƒ£  Create new project: 'earthcare-network'"
echo "4ï¸âƒ£  Add applications:"
echo ""
echo "   ğŸ“± APPLICATION 1: EarthCare Directory"
echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "   â€¢ Name: earthcare-directory"
echo "   â€¢ Type: Docker Compose"
echo "   â€¢ Source: Upload docker-compose.simple.yml"
echo "   â€¢ Domain: app.earthcare.network"
echo "   â€¢ Port: 8080"
echo "   â€¢ SSL: Enable Let's Encrypt"
echo ""
echo "   ğŸ¢ APPLICATION 2: Twenty CRM (External)"
echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "   â€¢ Name: twenty-crm"
echo "   â€¢ Type: External Service"
echo "   â€¢ Target: http://localhost:3001"
echo "   â€¢ Domain: crm.app.earthcare.network"
echo "   â€¢ Additional Domain: app.crm.app.earthcare.network"
echo "   â€¢ SSL: Enable Let's Encrypt"
echo ""
echo "   ğŸ§ª APPLICATION 3: MCP Testing Server"
echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "   â€¢ Name: mcp-server"
echo "   â€¢ Type: Docker"
echo "   â€¢ Image: node:18-alpine"
echo "   â€¢ Command: sh -c 'npm install axios express cors && node server.js'"
echo "   â€¢ Port: 8080"
echo "   â€¢ Volume: /opt/earthcare-deployment/mcp-server:/app"
echo "   â€¢ Environment:"
echo "     CRM_URL=https://crm.app.earthcare.network"
echo "     DIRECTORY_URL=https://app.earthcare.network"
echo ""
echo "ğŸŒ Domain Configuration (DNS already set):"
echo "   âœ… app.earthcare.network â†’ Directory"
echo "   âœ… crm.app.earthcare.network â†’ Twenty CRM"  
echo "   âœ… app.crm.app.earthcare.network â†’ Twenty CRM"
echo "   âœ… *.crm.app.earthcare.network â†’ Wildcard SSL"
echo ""
echo "ğŸ”§ Environment Variables for Twenty CRM:"
echo "   SERVER_URL=https://crm.app.earthcare.network"
echo "   FRONT_BASE_URL=https://crm.app.earthcare.network"
echo "   PG_DATABASE_URL=postgres://twenty:earthcare_pg_2024_secure@157.230.173.94:5432/default"
echo "   REDIS_URL=redis://157.230.173.94:6379"
echo "   CORS_ALLOWED_ORIGINS=https://crm.app.earthcare.network,https://app.crm.app.earthcare.network"
echo ""
echo "ğŸ§ª Testing URLs (after configuration):"
echo "   â€¢ Directory: https://app.earthcare.network"
echo "   â€¢ CRM: https://crm.app.earthcare.network"
echo "   â€¢ CRM Workspace: https://app.crm.app.earthcare.network"
echo "   â€¢ MCP Testing: curl https://mcp.earthcare.network/test-all"
echo ""
echo "ğŸ“ Post-Configuration Tasks:"
echo "   1. Install Twenty CRM separately or configure external source"
echo "   2. Test all SSL certificates"
echo "   3. Run full end-to-end test via MCP server"
echo "   4. Configure CI/CD pipeline for future deployments"
echo ""
echo "ğŸš€ Quick Test Commands:"
echo "   curl -I http://157.230.173.94:8080  # Directory test"
echo "   curl -I http://157.230.173.94:3000  # Dokploy dashboard"
echo ""
echo "ğŸ’¡ Need Help? Check logs with:"
echo "   ssh root@157.230.173.94 'docker logs earthcare-deployment-directory-1'"
echo ""

# Test current deployments
echo "ğŸ” Current Service Status:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Test Directory
if curl -s --max-time 5 http://157.230.173.94:8080 > /dev/null; then
    echo "âœ… Directory Service: Running at http://157.230.173.94:8080"
else
    echo "âŒ Directory Service: Not accessible"
fi

# Test Dokploy
if curl -s --max-time 5 http://157.230.173.94:3000 > /dev/null; then
    echo "âœ… Dokploy Dashboard: Running at http://157.230.173.94:3000"
else
    echo "âŒ Dokploy Dashboard: Not accessible"
fi

echo ""
echo "ğŸ‰ Ready for Dokploy configuration!"
echo "ğŸ“– Open http://157.230.173.94:3000 to get started"